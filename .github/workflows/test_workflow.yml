
name: Test Workflow

on:
  workflow_dispatch: {}  # manual run, no inputs

permissions:
  actions: read
  contents: write
  pull-requests: write

concurrency:
  group: arxml-diff-${{ github.ref }}
  cancel-in-progress: true

jobs:
  arxml-diff:
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # CHECKOUT BRANCHES
      # ------------------------
      - name: Checkout develop (current HEAD)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Checkout main into _main/
        uses: actions/checkout@v4
        with:
          ref: main
          path: _main
          fetch-depth: 0

      # ------------------------
      # DIAGNOSTICS & ARTIFACT (from triggering run)
      # ------------------------
      - name: List artifacts on triggering run
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload?.workflow_run?.id;
            if (!runId) {
              core.warning('No workflow_run.id in event payload; skipping artifact listing.');
              return;
            }
            const res = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
              per_page: 100
            });
            const artifacts = res?.data?.artifacts ?? [];
            core.info(`Found ${artifacts.length} artifacts on run ${runId}`);
            for (const a of artifacts) {
              core.info(`- ${a.name} (expired=${a.expired}, id=${a.id})`);
            }

      - name: Download selection artifact from triggering run
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: selected-repos
          path: .sync-meta
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: false

      # ------------------------
      # DETERMINE REPOS
      # ------------------------
      - name: Determine repos to process
        id: select_repos
        shell: bash
        run: |
          set -euo pipefail
          DEFAULT="ECM PCM HVAC_SVN BCM_SHAREPOINT ABS_JIRA"

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ ! -f ".sync-meta/selected_repos.txt" ]]; then
              echo "❌ Selection artifact missing for workflow_run."
              exit 1
            fi
          fi

          if [[ -f ".sync-meta/selected_repos.txt" ]]; then
            mapfile -t arr < <(grep -E '^\S' .sync-meta/selected_repos.txt | sort -u)
            if (( ${#arr[@]} > 0 )); then
              echo "Using selection: ${arr[*]}"
              echo "repos=${arr[*]}" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "No selection artifact; defaulting to all repos for manual run."
            echo "repos=${DEFAULT}" >> "$GITHUB_OUTPUT"
          else
            echo "❌ No selection resolved, and not a manual run."
            exit 1
          fi

      # ------------------------
      # PRE-RUN: Ensure BCM_SHAREPOINT is up-to-date (run Workflow 2 and wait)
      # ------------------------
      - name: Trigger BCM SharePoint sync workflow (Workflow 2)
        if: contains(steps.select_repos.outputs.repos, 'BCM_SHAREPOINT')
        id: trigger_bcm_sync
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_PAT }}
          script: |
            const owner = 'CICD-LTTS';
            const repo = 'BCM_SHAREPOINT';
            const workflow_id = '.github/workflows/sharepoint-to-github.yml';
            const ref = 'main';

            const startTs = new Date().toISOString();
            core.info(`Dispatching ${owner}/${repo}:${workflow_id} on ${ref} @ ${startTs}`);

            await github.rest.actions.createWorkflowDispatch({ owner, repo, workflow_id, ref });
            core.setOutput('startTs', startTs);

      - name: Wait for BCM SharePoint sync to finish
        if: contains(steps.select_repos.outputs.repos, 'BCM_SHAREPOINT')
        continue-on-error: true   # Allow this step to fail but continue the job (Option A)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_PAT }}
          script: |
            const owner = 'CICD-LTTS';
            const repo = 'BCM_SHAREPOINT';
            const workflow_id = '.github/workflows/sharepoint-to-github.yml';
            const startTs = '${{ steps.trigger_bcm_sync.outputs.startTs }}';

            const pollIntervalMs = 15000; // 15s
            const timeoutMs = 45 * 60 * 1000; // 45min
            const deadline = Date.now() + timeoutMs;

            async function findRecentRun() {
              for (let page = 1; page <= 5; page++) {
                const res = await github.rest.actions.listWorkflowRuns({
                  owner, repo, workflow_id, per_page: 50, page
                });
                const runs = res.data.workflow_runs || [];
                const candidate = runs.find(r => new Date(r.created_at) >= new Date(startTs));
                if (candidate) return candidate;
                if (runs.length < 50) break;
              }
              return null;
            }

            let run = null;
            while (!run) {
              if (Date.now() > deadline) {
                core.setFailed('Timed out waiting for BCM workflow run to be created.');
                return;
              }
              run = await findRecentRun();
              if (!run) {
                core.info(`No run after ${startTs} yet. Sleeping ${pollIntervalMs}ms...`);
                await new Promise(r => setTimeout(r, pollIntervalMs));
              }
            }

            core.info(`Found run id=${run.id} at ${run.html_url}. Polling...`);
            while (true) {
              const { data: fresh } = await github.rest.actions.getWorkflowRun({
                owner, repo, run_id: run.id
              });

              core.info(`status=${fresh.status}, conclusion=${fresh.conclusion}`);
              if (fresh.status === 'completed') {
                if (fresh.conclusion === 'success') {
                  core.info('BCM SharePoint sync completed successfully.');
                } else {
                  core.setFailed(`BCM SharePoint sync failed: ${fresh.conclusion}`);
                }
                break;
              }

              if (Date.now() > deadline) {
                core.setFailed(`Timed out waiting for run id=${run.id} to complete.`);
                break;
              }

              await new Promise(r => setTimeout(r, pollIntervalMs));
            }

      # ------------------------
      # SETUP BOTH ENGINES
      # ------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas openpyxl

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      # ------------------------
      # RUN DIFFS WITH BOTH ENGINES
      # ------------------------
      - name: Run ARXML diffs (Python + Java)
        env:
          REPOS: ${{ steps.select_repos.outputs.repos }}
        shell: bash
        run: |
          set -euo pipefail
          REPOS="${REPOS:?No repos provided}"

          echo "==== BRANCH CONTEXT ===="
          echo "COMPARE (develop): $(git rev-parse --abbrev-ref HEAD) @ $(git rev-parse --short HEAD)"
          if [[ -d "_main/.git" ]]; then
            echo "BASE (main) worktree present"
            echo "BASE commit: $(git -C _main rev-parse --short HEAD)"
          else
            echo "❗ ERROR: _main/ is missing or not a Git checkout."
            exit 1
          fi
          echo "========================"

          shopt -s nullglob
          IFS=' ' read -r -a REPOS_ARR <<< "$REPOS"

          for R in "${REPOS_ARR[@]}"; do
            echo "::group::[${R}] Exact-1-per-folder pairing"
            NEW_ROOT="${R}/files"
            OLD_ROOT="_main/${R}/files"
            OUT_DIR="${R}/${R}-DIFFERENCE"

            echo "NEW_ROOT: ${NEW_ROOT}"
            echo "OLD_ROOT: ${OLD_ROOT}"
            echo "OUT_DIR:  ${OUT_DIR}"

            rm -rf "${OUT_DIR}" || true
            mkdir -p "${OUT_DIR}"

            if [[ ! -d "$NEW_ROOT" ]]; then
              echo "⚠ Skipping ${R}: develop dir not found"
              echo "::endgroup::"
              continue
            fi
            if [[ ! -d "$OLD_ROOT" ]]; then
              echo "⚠ Skipping ${R}: main dir not found"
              echo "::endgroup::"
              continue
            fi

            mapfile -t DIRS_NEW < <(
              find "$NEW_ROOT" -type f -iname '*.arxml' -printf '%h\n' \
                | sed -E "s|^${NEW_ROOT}/?||; s|^$||; s|^$|.|" \
                | sort -u
            )
            mapfile -t DIRS_OLD < <(
              find "$OLD_ROOT" -type f -iname '*.arxml' -printf '%h\n' \
                | sed -E "s|^${OLD_ROOT}/?||; s|^$||; s|^$|.|" \
                | sort -u
            )

            mapfile -t DIRS < <(
              { printf "%s\n" "${DIRS_NEW[@]}"; printf "%s\n" "${DIRS_OLD[@]}"; } \
              | awk 'NF' | sort -u
            )

            total_pairs=0
            skipped=0

            for d in "${DIRS[@]}"; do
              NEW_DIR="$NEW_ROOT"
              OLD_DIR="$OLD_ROOT"
              [[ "$d" != "." ]] && NEW_DIR="$NEW_ROOT/$d" && OLD_DIR="$OLD_ROOT/$d"

              if [[ ! -d "$NEW_DIR" || ! -d "$OLD_DIR" ]]; then
                skipped=$((skipped+1))
                continue
              fi

              mapfile -t new_files < <(find "$NEW_DIR" -maxdepth 1 -type f -iname '*.arxml' -printf '%f\n' | sort)
              mapfile -t old_files < <(find "$OLD_DIR" -maxdepth 1 -type f -iname '*.arxml' -printf '%f\n' | sort)

              if (( ${#new_files[@]} == 1 && ${#old_files[@]} == 1 )); then
                nf="${new_files[0]}"
                of="${old_files[0]}"

                newf="${NEW_DIR}/${nf}"
                oldf="${OLD_DIR}/${of}"

                nf_base="${nf%.[aA][rR][xX][mM][lL]}"
                of_base="${of%.[aA][rR][xX][mM][lL]}"
                name_flat="${of_base}_vs_${nf_base}"

                out_python="${OUT_DIR}/${name_flat}_html.xlsx"
                out_java="${OUT_DIR}/${name_flat}.xlsx"

                # ---------- Python ----------
                python "./scripts/generate_arxml_difference.py" "$oldf" "$newf" "$out_python" || {
                  echo "  ❗ Python diff failed for $name_flat"
                }

                # ---------- Java (NO log files) ----------
                echo "  Running Java compare:"
                echo "    main:    $oldf"
                echo "    develop: $newf"
                echo "    output:  $out_java"

                if ! java -jar ./jar/arxmlDiffjar.jar "$oldf" "$newf" "$out_java"; then
                  echo "  ❗ Java diff failed for $name_flat"
                fi

                produced=0
                [[ -f "$out_python" ]] && produced=$((produced+1))
                [[ -f "$out_java" ]] && produced=$((produced+1))

                (( produced > 0 )) && total_pairs=$((total_pairs+1)) || {
                  echo "  ❗ No expected outputs found for $name_flat"
                }
              else
                skipped=$((skipped+1))
              fi
            done

            echo "==== ${R} SUMMARY ===="
            echo "  Pairs diffed: ${total_pairs}"
            echo "  Folders skipped: ${skipped}"
            echo "======================"
            echo "::endgroup::"
          done

      # ------------------------
      # COMMIT RESULTS
      # ------------------------
      - name: Commit and push diff results to develop
        shell: bash
        env:
          REPOS: ${{ steps.select_repos.outputs.repos }}
        run: |
          set -euo pipefail
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          IFS=' ' read -r -a REPOS_ARR <<< "${REPOS}"

          for R in "${REPOS_ARR[@]}"; do
            git add -A "${R}/${R}-DIFFERENCE" || true
          done

          if ! git diff --cached --quiet; then
            git commit -m "ARXML diffs (Python+Java): main vs develop [skip ci]"
            git push origin HEAD:refs/heads/develop
          else
            echo "No diff artifacts to commit."
          fi

      # ------------------------
      # UPLOAD OUTPUT ARTIFACTS
      # ------------------------
      - name: Upload diff artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: arxml-diff-outputs
          path: |
            ECM/ECM-DIFFERENCE/**
            PCM/PCM-DIFFERENCE/**
            HVAC_SVN/HVAC_SVN-DIFFERENCE/**
            BCM_SHAREPOINT/BCM_SHAREPOINT-DIFFERENCE/**
            ABS_JIRA/ABS_JIRA-DIFFERENCE/**
          if-no-files-found: ignore
          retention-days: 7

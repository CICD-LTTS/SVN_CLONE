name: ARXML config check

on:
  workflow_dispatch: 
jobs:
  configcheck:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install lxml

      - name: Run arxml config check
        id: check
        shell: bash
        run: |
          python - << 'PYCODE'
          import json
          import sys
          from lxml import etree

          ARXML_PATH = "test.arxml"
          CONFIG_PATH = "config_check.json"

          try:
            with open(CONFIG_PATH, "r", encoding="utf-8") as f:
              CONFIG = json.load(f)
          except Exception as e:
            print(f"CONFIG_ERROR: {e}")
            print("RESULT=False")
            sys.exit(1)

          try:
            tree = etree.parse(ARXML_PATH)
          except Exception as e:
            print(f"XML_PARSE_ERROR: {e}")
            print("RESULT=False")
            sys.exit(1)

          all_ok = True
          details = []

          for element_name, allowed_values in CONFIG.items():
            nodes = tree.findall(f".//{element_name}")
            if not nodes:
              all_ok = False
              details.append(f"{element_name}: MISSING")
              continue

            values = [(n.text or "").strip() for n in nodes]
            
            if element_name == "Baudrate":
              range_str = allowed_values[0]
              try:
                min_val, max_val = map(int, range_str.split("-"))
              except:
                all_ok = False
                details.append(f"Baudrate: INVALID FORMAT FOR CONFIG. SHOULB BE RANGE")
                continue

              invalid_nums = []
              for v in values:
                try:
                  num = int(v)
                  if not (min_val <= num <= max_val):
                    invalid_nums.append(v)
                except:
                  invalid_nums.append(v)
                  
              if invalid_nums:
                all_ok = False
                details.append(f"Baudrate: INVALID -> {', '.join(invalid_nums)} ; allowed range={min_val}-{max_val}")
              else:
                details.append(f"Baudrate: OK -> {', '.join(values)}")
                
            invalid = [v for v in values if v not in allowed_values]

            if invalid:
              all_ok = False
              details.append(f"{element_name}: INVALID -> {', '.join(invalid)} ; allowed={allowed_values}")
            else:
              details.append(f"{element_name}: OK -> {', '.join(values)}")

          print("CONFIG CHECK SUMMARY")
          for line in details:
            print(line)
          result = "TRUE" if all_ok else "False"
          print(f"RESULT={result}")

          sys.exit(0 if all_ok else 1)
          PYCODE       
